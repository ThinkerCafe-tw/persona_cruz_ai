```markdown
# 🎯🌌 Phase 3: Token 經濟學與成本追蹤模組 (建立商業運營能力)

**主導人格**: 🎯 CRUZ (推進), ⚔️ 金 (成本效益/優化)
**核心執行**: 🔥 火 (開發), 🏔️ 土 (架構/數據庫)
**需求分析**: 🌱 木 (產品/運營)
**質量保障**: 💧 水 (測試/數據準確性)

## 1. 階段目標

實現對 AI 服務調用（主要是 LLM Token 消耗）成本的監控、分析與管理。這是產品長期運營、成本控制、以及未來可能制定商業化策略的必要條件。

**核心產出**：
1.  一個能夠記錄每次 LLM 調用 Token 使用量的後端機制。
2.  一個簡單的管理儀表板（或 API），用於展示用戶/部門/代理人的 Token 消耗和預估成本。

參考：LibreChat 2025 年路線圖中提到為消息添加「預估成本」元數據的計畫，我們的實現可以借鑒或為其提供基礎。

## 2. 核心任務分解

**2.1. 後端 Token 使用量攔截與記錄 (🔥火 🏔️土)**

*   **攔截點定位 (🏔️土)**：
    *   最理想的攔截點是在 LibreChat 後端 (Node.js 主應用) **實際調用外部 LLM API (OpenAI, Azure, Anthropic, Google, 自訂端點等) 之前和之後**。
    *   需要找到統一處理對外 LLM 請求的代碼路徑。如果 LibreChat 本身有類似 `sendMessage` 或 `fetchLLMResponse` 的中心化函數，則在此處添加攔截邏輯最優。
    *   如果各個 AI Provider 的調用邏輯分散，則可能需要在多個適配器 (adapter) 或服務文件中添加。🏔️土 需進行代碼勘察。

*   **數據採集 (🔥火)**：
    *   **請求 Token 數**：對於大多數 LLM，輸入文本的 Token 數可以在發送請求前通過 tokenizer (如 `tiktoken` for OpenAI models) 計算得到。
    *   **響應 Token 數**：LLM API 的響應通常會直接包含 `usage` 字段，其中有 `prompt_tokens` (實際可能與前端計算略有差異，以 API 返回為準) 和 `completion_tokens`。
    *   **模型名稱**：記錄調用的具體模型 (e.g., `gpt-4o`, `claude-3-sonnet`)。
    *   **用戶 ID / Agent ID**: 記錄是哪個用戶或哪個 AI 代理人觸發的調用。
    *   **時間戳**: 調用時間。
    *   **對話 ID (Conversation ID)**: 關聯到具體的對話。
    *   **端點標識**: 標識是哪個 LLM 供應商或自定義端點。

*   **數據存儲 (🏔️土 🔥火)**：
    *   **數據庫選型**:
        *   可以考慮在現有的 **MongoDB** 中創建一個新的 Collection (e.g., `token_usage_logs`)。MongoDB 的靈活性適合存儲這類日誌型數據。
        *   或者，如果需要更複雜的聚合查詢和報表，也可以考慮存入 **PostgreSQL**（可能需要新建一個專用表）。🏔️土 權衡。
    *   **表/文檔結構**:
        ```json
        {
          "log_id": "uuid",
          "user_id": "string",
          "agent_id": "string", // 可選
          "conversation_id": "string",
          "model_name": "string",
          "endpoint_id": "string", // e.g., "openAI", "anthropic", "custom_my_model"
          "prompt_tokens": "number",
          "completion_tokens": "number",
          "total_tokens": "number",
          "estimated_cost_usd": "number", // 可選，基於預設的價格表計算
          "timestamp": "datetime"
        }
        ```
    *   **異步記錄**: Token 使用量的記錄應設計為異步操作，避免阻塞正常的 LLM 請求響應流程。可以考慮使用 Node.js 的事件隊列或一個輕量級的消息隊列。

**2.2. Token 價格管理 (⚔️金 🌱木)**

*   **價格表配置**:
    *   需要一個機制來存儲不同模型（甚至不同供應商的同一模型）的 Token 價格 (例如，每1K prompt tokens 的價格，每1K completion tokens 的價格)。
    *   可以通過一個配置文件 (`models_pricing.yaml` 或數據庫表) 來管理。⚔️金 負責收集和維護此價格信息。
    *   🌱木 需確認價格的計價單位（如美元 USD）。
*   **預估成本計算**:
    *   在記錄 Token 使用量時，可以根據模型名稱和 Token 數，從價格表中查詢對應價格，並計算出該次調用的預估成本，一併存儲。

**2.3. 成本展示儀表板/API (🔥火 🌸Serena)**

*   **V1 階段目標**: 提供基礎的成本可視化或數據提取能力。
*   **方案一：簡單管理儀表板 (🔥火 🌸Serena)**
    *   在 LibreChat 現有前端框架下，創建一個新的管理頁面 (僅限管理員訪問)。
    *   該頁面可以展示：
        *   總 Token 消耗、總預估成本 (可按時間範圍篩選)。
        *   按用戶/Agent ID/模型名稱匯總的 Token 消耗和成本。
        *   簡單的圖表展示趨勢。
    *   🌸Serena 設計界面，🔥火 實現前端組件和後端 API 接口。
*   **方案二：提供 API 接口 (🔥火)**
    *   如果 V1 不開發完整儀表板，至少應提供後端 API 接口，允許通過編程方式查詢 Token 使用日誌和聚合數據。
    *   例如：
        *   `GET /api/admin/token_usage?user_id=<id>&start_date=<date>&end_date=<date>`
        *   `GET /api/admin/token_usage/summary?group_by=user&start_date=<date>&end_date=<date>`
*   🌱木 根據初期運營需求，決定 V1 採用哪種方案或兩者結合。

## 3. 驗收標準 (💧 水 ⚔️ 金 🌱 木)**

*   **數據準確性**:
    *   記錄的 Token 數量與 LLM 供應商實際計費的 Token 數基本一致 (💧水 需抽樣驗證)。
    *   預估成本計算準確。
*   **功能完整性**:
    *   所有 LLM 調用的 Token 使用量都被記錄下來。
    *   管理儀表板 (或 API) 能正確展示所需數據和匯總信息。
    *   可按用戶、時間等維度進行篩選和查詢。
*   **性能影響**: Token 記錄過程對正常聊天響應時間的影響極小 (⚔️金 測試)。
*   **安全性**: 成本數據和管理界面應有嚴格的權限控制，僅管理員可訪問 (🏔️土 確認)。

## 4. 風險與應對 (🎯 CRUZ 監控)

*   **多供應商 Token 計算差異**: 不同 LLM 供應商對 Token 的計算方式可能存在細微差異。
    *   **應對**: 優先以 API 返回的 `usage` 數據為準。對於請求 Token，`tiktoken` 適用於 OpenAI 模型，其他模型可能需要各自的 tokenizer 或估算方法。⚔️金 研究。
*   **價格表維護**: 模型價格可能頻繁變動。
    *   **應對**: 建立流程定期更新價格表。⚔️金 負責。
*   **數據量增長**: Token 使用日誌可能會快速增長，對數據庫性能和存儲造成壓力。
    *   **應對**: 🏔️土 設計合理的索引，考慮數據歸檔或聚合策略。
*   **攔截點的全面性**: 確保所有可能的 LLM 調用路徑都被覆蓋到。
    *   **應對**: 🔥火 和 🏔️土 進行仔細的代碼審查和測試。

## 5. 五行人格協作要點

*   ⚔️ **金**：主導成本效益分析，收集和維護模型價格信息，設計成本優化建議，驗證數據準確性。
*   🔥 **火**：負責前後端的核心開發工作，包括 Token 攔截、存儲邏輯和儀表板/API 實現。
*   🏔️ **土**：提供數據庫選型和表結構設計建議，確保 Token 記錄的性能和可擴展性，把關攔截點的架構合理性。
*   🌱 **木**：明確運營方對成本追蹤的具體需求（如需追蹤到哪個粒度，需要哪些報表維度），定義價格策略。
*   💧 **水**：設計測試案例，重點驗證 Token 計數的準確性、成本計算的正確性以及儀表板數據的正確展示。
*   🎯 **CRUZ**：確保此功能按時交付，因為它直接關係到產品的運營可行性。

**此階段的完成將為產品的精細化運營和未來商業化打下堅實的數據基礎。**
```
