```markdown
# 🎯🌌 Phase 2: 可嵌入式 Widget 與初步品牌化 (實現產品交付)

**主導人格**: 🎯 CRUZ (推進), 🌱 木 (產品規劃)
**核心執行**: 🔥 火 (開發), 🌸 Serena (UI/UX 設計)
**架構支持**: 🏔️ 土 (安全與集成)
**質量保障**: 💧 水 (測試)

## 1. 階段目標

讓我們的「個性化 AI 助手」能夠被整合到目標業務場景中（例如，作為 iframe 嵌入到現有的網站或業務平台），並完成初步的品牌化改造，使其具備初步的產品形態和交付能力。

**核心產出**：
1.  一個功能可用的、基於 iframe 的「可嵌入式 Widget V1」。
2.  AI 助手界面完成基礎的品牌化調整（Logo, 名稱, 主色調）。

## 2. 核心任務分解

**2.1. 開發「可嵌入式 iframe Widget V1」 (🔥火 🌸Serena 🏔️土)**

此任務基於 `../c03_ui_ux_integration_wood_fire/f03_embeddable_widget_design_v1.md` 中的設計方案。

*   **前端 (React - 🔥火 🌸Serena)**:
    *   **創建 `/embed` 路由和專用視圖**: 實現一個精簡版的聊天 UI，移除不適用於嵌入場景的元素（如完整側邊欄、全局導航等）。🌸Serena 提供精簡後的 UI 設計稿。
    *   **從 URL 獲取認證令牌**: `/embed` 視圖加載時，能從 URL query parameter (e.g., `?token=xxx`) 中讀取 JWT。
    *   **調用後端驗證令牌**: 將獲取的 JWT 發送給後端進行驗證。
    *   **UI 適應性**: 確保嵌入式 UI 在不同大小的 iframe 容器中能有良好的響應式表現。
    *   **(可選 V1.x)** 實現 `window.postMessage` 的基本監聽和發送機制，用於與父頁面進行簡單通信（如展開/收起）。

*   **後端 (Node.js - 🔥火 🏔️土)**:
    *   **令牌頒發接口**:
        *   創建 `POST /api/widget/generate_auth_token` 接口。
        *   實現對請求方（父應用後端）的身份驗證邏輯 (🏔️土 負責設計安全機制，如共享密鑰或 IP 校驗)。
        *   為指定用戶（或匿名用戶，由 🌱木 確定業務邏輯）生成短時效、一次性的 JWT。JWT payload 應包含必要信息，如 `user_id`, `permissions` 等。
    *   **令牌驗證邏輯**:
        *   前端 `/embed` 視圖將令牌發送到後端（可通過一個現有或新的接口），後端驗證 JWT 的簽名、時效性和內容。
        *   驗證成功後，為該請求建立有效的用戶會話。
    *   **安全加固 (🏔️土)**:
        *   確保 JWT 使用強加密算法 (如 HS256/RS256)。
        *   設置合理的令牌過期時間。
        *   防止重放攻擊（例如，一次性令牌）。
        *   配置 HTTP 安全頭，如 `Content-Security-Policy` (CSP) 的 `frame-ancestors` 指令，以限制哪些域名可以嵌入此 iframe，防止點擊劫持。

**2.2. 初步品牌化改造 (🌸Serena 🔥火)**

此任務基於 `../c03_ui_ux_integration_wood_fire/f01_ui_stack_and_branding.md` 中的分析。

*   **替換 Logo**: 在前端 React 應用的相關組件中，替換為我們「個性化 AI 助手計畫」的 Logo。🌸Serena 提供 Logo 素材。
*   **修改應用名稱/標題**: 在 UI 的可見位置（如頁面標題、導航欄等）更新為我們的產品名稱。
*   **調整主色調**:
    *   修改 `tailwind.config.js` 和/或全局 CSS (`globals.css`) 以應用我們品牌的主色系。
    *   利用 shadcn/ui 的 CSS 變量體系進行主題顏色調整。🌸Serena 提供品牌色板。
*   **字體調整 (可選 V1)**: 如果品牌有特定字體要求，進行相應配置。

## 3. 驗收標準 (💧 水 🌱 木 🌸Serena)

*   **Widget 功能**:
    *   可以通過一個帶有有效 JWT 的 URL (e.g., `https://<our-librechat>/embed?token=xxx`) 在 iframe 中成功加載精簡版聊天界面。
    *   嵌入式聊天界面功能（發送消息、接收回復、基礎交互）正常工作。
    *   無效或過期的 JWT 應導致認證失敗，無法加載聊天界面。
    *   嵌入式界面在常見的 iframe 尺寸下顯示正常，無明顯佈局問題。
*   **品牌化**:
    *   應用程序的 Logo 已替換為新 Logo。
    *   應用程序的名稱/標題已更新。
    *   界面的主色調已更新為品牌色。
*   **安全性**:
    *   令牌頒發接口有基本的請求方驗證。
    *   CSP `frame-ancestors` 已配置，只允許指定的父域名嵌入。
*   **文檔**:
    *   🔥火 或 🏔️土 需提供關於如何生成 JWT 及構建 iframe URL 的基本開發者文檔/指南。

## 4. 風險與應對 (🎯 CRUZ 監控)

*   **iframe 安全性挑戰**: 跨域通信、點擊劫持等是 iframe 固有的安全風險。🏔️土 需投入足夠精力進行安全設計和測試。
    *   **應對**: 嚴格的 CSP 策略，安全的令牌機制，對 `postMessage` 的來源進行嚴格驗證。
*   **UI/UX 在受限空間的挑戰**: 在小尺寸 iframe 內保持良好的用戶體驗是一個設計難點。🌸Serena 需要多次迭代。
    *   **應對**: 優先保證核心聊天功能的易用性，簡化次要交互。
*   **與 LibreChat 更新的兼容性**: 前端 UI 的修改如果過於深入，可能增加未來合併 LibreChat 上游更新的難度。
    *   **應對**: 🔥火 在修改時盡量保持模塊化，將客製化樣式和組件與原始 shadcn/ui 組件隔離。

## 5. 五行人格協作要點

*   🌱 **木**：明確 Widget 的核心使用場景和目標集成平台，定義品牌化的基本要求。
*   🔥 **火**：主力負責前後端的功能開發，特別是 React 視圖和 Node.js 認證邏輯。
*   🌸 **Serena**：主導 Widget UI 的精簡化設計和品牌視覺風格的落地，確保嵌入式體驗的流暢性。
*   🏔️ **土**：重點關注 Widget 的安全架構，特別是令牌機制和 CSP 配置，確保與父應用的安全集成。
*   💧 **水**：設計全面的測試案例，覆蓋功能、UI、安全性和跨瀏覽器兼容性。
*   🎯 **CRUZ**：此階段是產品能否「走出去」的關鍵，需緊盯進度，確保按時交付可演示的嵌入式原型。

**此階段的完成將標誌著我們的 AI 助手具備了初步的產品形態和對外整合能力。**
```
